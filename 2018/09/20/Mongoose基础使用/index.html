<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Mongoose基础使用 | Typing</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Mongoose基础使用</h1><a id="logo" href="/.">Typing</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Mongoose基础使用</h1><div class="post-meta">Sep 20, 2018</div><a class="disqus-comment-count" href="/2018/09/20/Mongoose基础使用/#vcomment"><span class="valine-comment-count" data-xid="/2018/09/20/Mongoose基础使用/"></span><span> Comment</span></a><div class="post-content"><p><a href="https://mongoosejs.com/" target="_blank" rel="noopener">Mongoose version 5.2.16 文档</a><br>1.连接数据库<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost:27017/mongo'</span>, &#123; <span class="attr">useNewUrlParser</span>: <span class="literal">true</span> &#125;);</span><br></pre></td></tr></table></figure></p>
<p>2.如果连接成功或者失败，进行通知，执行回调函数<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> db = mongoose.connection;</span><br><span class="line">db.on(<span class="string">'error'</span>, <span class="built_in">console</span>.error.bind(<span class="built_in">console</span>, <span class="string">'connection error:'</span>));</span><br><span class="line">db.once(<span class="string">'open'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="comment">//连接成功之后执行回调函数</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Connected'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>3.创建一个Schema<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> kittySchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    name: <span class="built_in">String</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>3.Compiling schema into a Model<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Kitten = mongoose.model(<span class="string">'Kitten'</span>, kittySchema);</span><br></pre></td></tr></table></figure></p>
<p>4.给Schema添加functionality，方法必须在使用<code>mongoose.model()</code>之前，添加进Schema<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kittySchema.methods.speak = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> greeting = <span class="keyword">this</span>.name</span><br><span class="line">    ? <span class="string">"Meow name is "</span> + <span class="keyword">this</span>.name</span><br><span class="line">    : <span class="string">"I don't have a name"</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(greeting);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> Kitten = mongoose.model(<span class="string">'Kitten'</span>, kittySchema);</span><br></pre></td></tr></table></figure></p>
<h3 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h3><p>1.创建Schema<br>Each schema maps to a MongoDB collection and defines the shape of the documents within that collection.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">var</span> Schema = mongoose.Schema;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> blogSchema = <span class="keyword">new</span> Schema(&#123;</span><br><span class="line">    title: <span class="built_in">String</span>,</span><br><span class="line">    author: <span class="built_in">String</span>,</span><br><span class="line">    body: <span class="built_in">String</span>,</span><br><span class="line">    comments: [&#123; <span class="attr">body</span>: <span class="built_in">String</span>, <span class="attr">date</span>: <span class="built_in">Date</span> &#125;],</span><br><span class="line">    date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">    hidden: <span class="built_in">Boolean</span>,</span><br><span class="line">    meta: &#123;</span><br><span class="line">        votes: <span class="built_in">Number</span>,</span><br><span class="line">        favs: <span class="built_in">Number</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>Keys may also be assigned nested objects containing further key/type definitions like the <code>meta</code>property above.<br>2.Creating a model<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Blog = mongoose.model(<span class="string">'Blog'</span>, blogSchema);</span><br></pre></td></tr></table></figure></p>
<p>3.Instance methods<br>Instances of Models are documents. Documents have many of their own built-in instance methods. We may also define our own custom document instance methods too.<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Schema = mongoose.Schema;</span><br><span class="line"><span class="keyword">var</span> animalSchema = <span class="keyword">new</span> Schema(&#123; <span class="attr">name</span>: <span class="built_in">String</span>, <span class="attr">type</span>: <span class="built_in">String</span> &#125;);</span><br><span class="line">animalSchema.methods.findSimilarTypes = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//返回的result作为参数传给callback函数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.model(<span class="string">'Animal'</span>).find(&#123; <span class="attr">type</span>: <span class="keyword">this</span>.type &#125;, callback);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> Animal = mongoose.model(<span class="string">'Animal'</span>, animalSchema);</span><br><span class="line"><span class="keyword">var</span> dog = <span class="keyword">new</span> Animal(&#123; <span class="attr">type</span>: <span class="string">'dog'</span> &#125;);</span><br><span class="line">dog.findSimilarTypes(<span class="function"><span class="keyword">function</span> (<span class="params">err, dogs</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(dogs);<span class="comment">// 打印出数据库中所有的type为dog的信息</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>4.Statics<br>给Model添加静态方法：</p>
<h3 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h3><p>1.创建一个实例并且添加进数据库<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建一个instance</span></span><br><span class="line"><span class="keyword">var</span> fluffy = <span class="keyword">new</span> Kitten(&#123; <span class="attr">name</span>: <span class="string">'Fluffy'</span> &#125;);</span><br><span class="line"><span class="comment">//1.使用save存进数据库</span></span><br><span class="line">fluffy.save(<span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);</span><br><span class="line">    <span class="comment">//saved!</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//2.使用create</span></span><br><span class="line"><span class="keyword">var</span> Mandy = <span class="keyword">new</span> Kitten(&#123; <span class="attr">name</span>: <span class="string">'Mandy'</span> &#125;);</span><br><span class="line">Kitten.create(Mandy, <span class="function"><span class="keyword">function</span> (<span class="params">err, Mandy</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);</span><br><span class="line">    <span class="comment">//saved!</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//3.插入批数量的实例，使用insertMany()</span></span><br></pre></td></tr></table></figure></p>
<p>2.Querying 查询<br>Mongoose models提供了许多方法来实现增删查改，每个方法都返回一个mongoose query对象<br>一个mongoose查询可以有两种方式来执行，一种是传递一个回调函数，这样会立刻执行；<br>一个query含有<code>.then()</code>方法，因此可以像使用Promise一样来使用。<br>1.传递callback<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> PersonSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    name: <span class="built_in">String</span>,</span><br><span class="line">    ocupation: <span class="built_in">String</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> Person = mongoose.model(<span class="string">'Person'</span>, PersonSchema);</span><br><span class="line"><span class="comment">// //创建一个实例</span></span><br><span class="line"><span class="comment">// var Mandy = new Person(&#123; name: 'Mandy', ocupation: 'Student' &#125;);</span></span><br><span class="line"><span class="comment">// Person.create(Mandy, function (err, Mandy) &#123;</span></span><br><span class="line"><span class="comment">//     if (err) return handleError(err);</span></span><br><span class="line"><span class="comment">//     console.log('Saved!');</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line">Person.findOne(&#123; <span class="string">'name'</span>: <span class="string">'Mandy'</span> &#125;, <span class="string">'name ocupation'</span>, <span class="comment">/*选择name和ocupation*/</span><span class="function"><span class="keyword">function</span> (<span class="params">err, person</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);</span><br><span class="line">    <span class="built_in">console</span>.log(person.name, <span class="string">' '</span>, person.ocupation);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>上面这个查询会立刻执行，并且结果会被传递到回调函数中去。<br>2.接下来，是不使用callback的情况<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> query = Person.findOne(&#123; <span class="string">'name'</span>: <span class="string">'Mandy'</span> &#125;);</span><br><span class="line"><span class="comment">// selecting the `name` and `occupation` fields</span></span><br><span class="line">query.select(<span class="string">'name ocupation'</span>);</span><br><span class="line"><span class="comment">// execute the query at a later time</span></span><br><span class="line">query.exec(<span class="function"><span class="keyword">function</span> (<span class="params">err, person</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> handleError(err);</span><br><span class="line">    <span class="comment">// Prints "Space Ghost is a talk show host."</span></span><br><span class="line">    <span class="built_in">console</span>.log(person.name, <span class="string">' '</span>, person.ocupation);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>上面的<code>query</code>是一种<code>Query</code>，可以使用链式语法来完成查询<br>下面两种查询方式是等价的：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// With a JSON doc</span></span><br><span class="line">Person.</span><br><span class="line">  find(&#123;</span><br><span class="line">    occupation: <span class="regexp">/host/</span>,</span><br><span class="line">    <span class="string">'name.last'</span>: <span class="string">'Ghost'</span>,</span><br><span class="line">    age: &#123; <span class="attr">$gt</span>: <span class="number">17</span>, <span class="attr">$lt</span>: <span class="number">66</span> &#125;,</span><br><span class="line">    likes: &#123; <span class="attr">$in</span>: [<span class="string">'vaporizing'</span>, <span class="string">'talking'</span>] &#125;</span><br><span class="line">  &#125;).</span><br><span class="line">  limit(<span class="number">10</span>).</span><br><span class="line">  sort(&#123; <span class="attr">occupation</span>: <span class="number">-1</span> &#125;).</span><br><span class="line">  select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">occupation</span>: <span class="number">1</span> &#125;).</span><br><span class="line">  exec(callback);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Using query builder</span></span><br><span class="line">Person.</span><br><span class="line">  find(&#123; <span class="attr">occupation</span>: <span class="regexp">/host/</span> &#125;).</span><br><span class="line">  where(<span class="string">'name.last'</span>).equals(<span class="string">'Ghost'</span>).</span><br><span class="line">  where(<span class="string">'age'</span>).gt(<span class="number">17</span>).lt(<span class="number">66</span>).</span><br><span class="line">  where(<span class="string">'likes'</span>).in([<span class="string">'vaporizing'</span>, <span class="string">'talking'</span>]).</span><br><span class="line">  limit(<span class="number">10</span>).</span><br><span class="line">  sort(<span class="string">'-occupation'</span>).</span><br><span class="line">  select(<span class="string">'name occupation'</span>).</span><br><span class="line">  exec(callback);</span><br></pre></td></tr></table></figure></p>
<p>3.Queries are not promises<br>Mongoose queries are not promises. They have a <code>.then()</code> function for<br><a href="https://www.npmjs.com/package/co" target="_blank" rel="noopener">co</a> and <a href="http://thecodebarbarian.com/common-async-await-design-patterns-in-node.js.html" target="_blank" rel="noopener">async/await</a> as a convenience.</p>
</div><div class="tags"><a href="/tags/mongoose/">mongoose</a></div><div class="post-nav"><a class="next" href="/2018/09/17/编写中间件以用于Express应用程序/">编写中间件以用于Express应用程序</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'true' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'gkQIV1MpvwQmdjHWEYG7aq4W-gzGzoHsz',
  appKey:'g6GJ7T0ISUA6YTDlEJBDnyo6',
  placeholder:'Just so so',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categories</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Tags</i></div><div class="tagcloud"><a href="/tags/es6/" style="font-size: 15px;">es6</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/express/" style="font-size: 15px;">express</a> <a href="/tags/mongoose/" style="font-size: 15px;">mongoose</a> <a href="/tags/middleware/" style="font-size: 15px;">middleware</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/20/Mongoose基础使用/">Mongoose基础使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/17/编写中间件以用于Express应用程序/">编写中间件以用于Express应用程序</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/17/使用中间件/">Express—使用中间件</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/16/Express学习记录/">Express学习记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/16/ES6-Promise对象/">ES6 Promise对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/01/2018-9-1申请Apple美区id/">2018/9/1申请Apple美区id</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Links</i></div><ul></ul><a href="http://www.google.com/" title="Google" target="_blank">Google</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Typing.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>